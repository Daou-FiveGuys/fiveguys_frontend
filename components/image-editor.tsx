'use client'

import { useEffect, useRef, useState } from 'react'
import {
  Canvas,
  CanvasOptions,
  Circle,
  Triangle,
  Rect,
  Object as FabricObject,
  PencilBrush,
  Textbox
} from 'fabric'
import * as fabric from 'fabric'
import { Button } from '@/components/ui/button'
import { Card, CardContent } from '@/components/ui/card'
import {
  Circle as CircleIcon,
  Hand as HandIcon,
  ItalicIcon,
  BoldIcon,
  HighlighterIcon,
  LetterTextIcon,
  Pen,
  Square,
  Triangle as TriangleIcon,
  Eraser,
  ChevronDown
} from 'lucide-react'
import {
  Popover,
  PopoverContent,
  PopoverTrigger
} from '@/components/ui/popover'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select'
import { ChromePicker, ColorResult } from 'react-color'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu'

const thicknesses = [1, 2, 3, 5, 8, 13, 21, 34, 40]

export default function ImageEditor() {
  const canvasRef = useRef<HTMLCanvasElement>(null)
  const [canvas, setCanvas] = useState<Canvas | null>(null)
  const [activeShape, setActiveShape] = useState<string | null>(null)
  const [currentColor, setCurrentColor] = useState('#000000')
  const [currentThickness, setCurrentThickness] = useState(5)
  const [recentColors, setRecentColors] = useState<string[]>([])

  useEffect(() => {
    if (canvasRef.current) {
      const options: Partial<CanvasOptions> = {
        width: 800,
        height: 600,
        backgroundColor: '#f0f0f0'
      }
      const fabricCanvas = new Canvas(canvasRef.current, options)
      fabricCanvas.isDrawingMode = false
      setCanvas(fabricCanvas)

      return () => {
        fabricCanvas.dispose()
      }
    }
  }, [])

  const addShape = (shape: string) => {
    if (!canvas) return

    let fabricShape: FabricObject

    const shapeOptions = {
      fill: 'transparent',
      stroke: currentColor,
      strokeWidth: currentThickness,
      left: 100,
      top: 100
    }

    switch (shape) {
      case 'circle':
        fabricShape = new Circle({
          ...shapeOptions,
          radius: 50
        })
        break
      case 'triangle':
        fabricShape = new Triangle({
          ...shapeOptions,
          width: 100,
          height: 100
        })
        break
      case 'rectangle':
        fabricShape = new Rect({
          ...shapeOptions,
          width: 100,
          height: 100
        })
        break
      default:
        return
    }

    canvas.add(fabricShape)
    canvas.renderAll()
    setActiveShape(shape)
  }
  //ÎèÑÌòï Ï∂îÍ∞Ä Í∏∞Îä•

  const enableDrawing = () => {
    if (!canvas) return

    canvas.isDrawingMode = true
    canvas.freeDrawingBrush = new PencilBrush(canvas)
    if (canvas.freeDrawingBrush) {
      canvas.freeDrawingBrush.width = currentThickness
      canvas.freeDrawingBrush.color = currentColor
    }
    setActiveShape('pen')
  }
  //Ìéú Í∏∞Îä•

  const disableDrawing = () => {
    if (!canvas) return

    canvas.isDrawingMode = false
    setActiveShape(null)
  }

  const enableErasing = () => {
    if (!canvas) return

    canvas.isDrawingMode = false
    canvas.off('mouse:down')
    canvas.on('mouse:down', function (options) {
      if (options.target) {
        canvas.remove(options.target)
        canvas.renderAll()
      }
    })
    setActiveShape('eraser')
  }
  //ÏßÄÏö∞Í∏∞ Í∏∞Îä•

  const disableErasing = () => {
    if (!canvas) return

    canvas.off('mouse:down')
  }

  useEffect(() => {
    if (!canvas) return

    const handleSelection = () => {
      if (activeShape !== 'eraser') {
        canvas.selection = true
        canvas.forEachObject(obj => {
          obj.selectable = true
        })
      } else {
        canvas.selection = false
        canvas.forEachObject(obj => {
          obj.selectable = false
        })
      }
    }

    handleSelection()
  }, [canvas, activeShape])

  useEffect(() => {
    if (canvas && canvas.freeDrawingBrush) {
      canvas.freeDrawingBrush.color = currentColor
      canvas.freeDrawingBrush.width = currentThickness
    }
  }, [canvas, currentColor, currentThickness])

  const handleColorChange = (
    color: ColorResult,
    event: React.ChangeEvent<HTMLInputElement>
  ) => {
    setCurrentColor(color.hex)
    // Only add to recent colors if it's not from dragging (i.e., if it's a complete change)
    if (event.type === 'change') {
      setRecentColors(prevColors => {
        const newColors = [
          color.hex,
          ...prevColors.filter(c => c !== color.hex)
        ]
        return newColors.slice(0, 6)
      })
    }
  }
  //ÏÉâÏÉÅ ÌååÏª§Ïóê ÏÉâÏÉÅ Ï∂îÍ∞Ä(Îã§ ÏïàÏ±ÑÏõåÏßÑ ÏÉÅÌÉú)

  const handleColorChangeComplete = (color: ColorResult) => {
    setCurrentColor(color.hex)
    setRecentColors(prevColors => {
      const newColors = [color.hex, ...prevColors.filter(c => c !== color.hex)]
      return newColors.slice(0, 6)
    })
  }
  //ÏÉâÏÉÅ ÌååÏª§Ïóê ÏÉâÏÉÅ Ï∂îÍ∞Ä(Ï†ÑÎ∂Ä Ï±ÑÏõåÏßÑ ÏÉÅÌÉú)

  /**
   *
   * ÍπÄÏÉÅÏ§Ä
   *
   *
   *
   *
   *
   *
   *
   *
   *
   *
   *
   *
   *
   *
   */

  const [font, setFont] = useState<string>('Arial')
  const [fontSize, setFontSize] = useState<number>(20)
  const [isAddingText, setIsAddingText] = useState<boolean>(false)
  const [isTyping, setIsTyping] = useState(false)
  const [isBold, setIsBold] = useState(false)
  const [isUnderline, setIsUnderline] = useState(false)
  const [isItalic, setIsItalic] = useState(false)
  const [isHighlighter, setIsHighlighter] = useState(false)
  const [highlighterColor, setHighlighterColor] = useState({
    r: 0,
    g: 0,
    b: 0,
    a: 1
  })
  const [currentTextColor, setCurrentTextColor] = useState('rgba(0, 0, 0, 255)')

  const [isMovingObject, setIsMovingObject] = useState<boolean>(false)
  const [isPopoverOpen, setIsPopoverOpen] = useState(false)
  const textRef = useRef<fabric.IText | null>(null) // text Í∞ùÏ≤¥Î•º Ï∂îÏ†ÅÌïòÎäî ref
  const [apiTextData, setApiTextData] = useState([
    'ÏïàÎÖïÌïòÏÑ∏Ïöî! üòä',
    'Î∞©ÌïôÏùÑ ÎßûÏù¥ÌïòÏó¨ ÌïúÏÑ±ÎåÄÌïôÍµêÏóêÏÑú ÏΩîÎî© Ï∫†ÌîÑÎ•º ÏßÑÌñâÌï©ÎãàÎã§!',
    'ÏùºÏãúÎäî 2024ÎÖÑ 12Ïõî 3Ïùº (ÌôîÏöîÏùº)Ïù¥Î©∞, ÏãúÍ∞ÑÏùÄ 10:00 - 12:00ÏûÖÎãàÎã§',
    'Ïû•ÏÜåÎäî ÌïúÏÑ±ÎåÄÌïôÍµê ÏÉÅÏÉÅÍ¥Ä 6Ï∏µÏûÖÎãàÎã§',
    'ÏΩîÎî©Ïóê Í¥ÄÏã¨Ïù¥ ÏûàÎäî ÌïôÏÉùÎì§Ïùò ÎßéÏùÄ Ï∞∏Ïó¨ Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§!',
    'Ìï®Íªò Ïû¨ÎØ∏ÏûàÎäî ÏãúÍ∞ÑÏùÑ Î≥¥ÎÇ¥Ïöî! üñ•Ô∏èüíª',
    'Í∞êÏÇ¨Ìï©ÎãàÎã§!'
  ])

  const enableAddText = () => {
    setActiveShape('text')
    setIsAddingText(true)
  }

  const disableAddText = () => {
    setIsAddingText(false)
  }

  const handleTextColorChange = (color: ColorResult) => {
    const { r, g, b, a } = color.rgb
    setCurrentTextColor(`rgba(${r}, ${g}, ${b}, ${a})`)
  }

  const handleTextColorChangeComplete = (color: ColorResult) => {
    const { r, g, b, a } = color.rgb
    setCurrentTextColor(`rgba(${r}, ${g}, ${b}, ${a})`)
  }

  const getIText = (str: string) => {
    const text = new fabric.IText(str, {
      editable: true,
      width: 150,
      fontWeight: isBold ? 800 : 300,
      fontSize: fontSize,
      fill: currentTextColor,
      fontFamily: font,
      underline: isUnderline,
      backgroundColor: isHighlighter
        ? `rgba(${highlighterColor.r}, ${highlighterColor.g}, ${highlighterColor.b}, ${highlighterColor.a})`
        : 'rgba(0, 0, 0, 0)',
      fontStyle: isItalic ? 'italic' : 'normal'
    })
    text.textAlign = 'left'
    text.set({ width: text.width + 30 })
    text.enterEditing()
    setIsTyping(true)
    text.on('editing:entered', () => {
      setIsTyping(true)
    })

    // Ìé∏ÏßëÏù¥ ÎÅùÎÇ† ÎïåÎäî setIsTyping(false)
    text.on('editing:exited', () => {
      setIsTyping(false)
    })
    return text
  }

  const addTextByButton = (value: string) => {
    if (!canvas) return
    const text = getIText(value)
    text.left = textRef.current == null ? 100 : textRef.current.left
    text.top =
      textRef.current == null
        ? 100
        : textRef.current.top + text.fontSize + textRef.current.fontSize
    textRef.current = text
    canvas.add(text)
    canvas.setActiveObject(text)
  }

  // ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
  const handleAddText = (e: fabric.DropEventData) => {
    if (!canvas) return

    const pointer = canvas.getPointer(e.e)
    if (e.target) return

    if (isAddingText) {
      const text = getIText('')
      text.left = pointer.x
      text.top = pointer.y

      // ÌÖçÏä§Ìä∏ Í∞ùÏ≤¥Î•º refÎ°ú Í¥ÄÎ¶¨ÌïòÏó¨ Ï∂îÏ†Å
      textRef.current = text
      canvas.add(text)
      canvas.setActiveObject(text)
    }
  }

  useEffect(() => {
    if (!canvas || !textRef.current) return
    const text = textRef.current

    // Ìé∏ÏßëÏù¥ ÏãúÏûëÎê† Îïå setIsTyping(true)
    text.on('editing:entered', () => {
      setIsTyping(true)
    })

    // Ìé∏ÏßëÏù¥ Ï¢ÖÎ£åÎê† Îïå setIsTyping(false)
    text.on('editing:exited', () => {
      setIsTyping(false)
    })

    // ÌÖçÏä§Ìä∏ Í∞ùÏ≤¥Í∞Ä ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏùÑ Îïå, Îã§Ïãú Ìé∏ÏßëÏùÑ ÏãúÏûëÌïòÎ©¥ `setIsTyping`Ïù¥ Ï†ÅÏö©ÎêòÎèÑÎ°ù ÏÑ§Ï†ï
    const handleTextClick = (e: fabric.DropEventData) => {
      if (e.target && e.target === text && !text.isEditing) {
        // ÌÖçÏä§Ìä∏Í∞Ä ÌôúÏÑ±ÌôîÎêòÍ≥† Ìé∏Ïßë Î™®ÎìúÏóê Îì§Ïñ¥Í∞îÏùÑ Îïå
        text.enterEditing()
        setIsTyping(true)
      }
    }

    // ÌÖçÏä§Ìä∏ Í∞ùÏ≤¥ ÌÅ¥Î¶≠ Ïãú Ìé∏Ïßë ÏÉÅÌÉú ÏãúÏûë
    canvas.on('mouse:down', handleTextClick)

    // Cleanup (Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ïñ∏ÎßàÏö¥Ìä∏ÎêòÍ±∞ÎÇò ÌÖçÏä§Ìä∏Í∞Ä ÏÇ≠Ï†úÎê† Îïå)
    return () => {
      canvas.off('mouse:down', handleTextClick)
      if (text) {
        text.off('editing:entered')
        text.off('editing:exited')
      }
    }
  }, [canvas])

  var handleClick: (e: fabric.DropEventData) => void
  useEffect(() => {
    if (!canvas) return
    if (isAddingText) {
      // canvasÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
      if (handleClick) canvas.off('mouse:down', handleClick)
      handleClick = (e: fabric.DropEventData) => handleAddText(e)
      canvas.on('mouse:down', handleClick)
      // Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ïñ∏ÎßàÏö¥Ìä∏Îê† Îïå Ïù¥Î≤§Ìä∏ Ï†úÍ±∞
      return () => {
        canvas.off('mouse:down', handleClick)
      }
    }
  }, [
    canvas,
    isAddingText,
    currentTextColor,
    fontSize,
    font,
    isBold,
    isUnderline,
    isItalic,
    isHighlighter,
    highlighterColor,
    apiTextData
  ])

  const enableMoveObject = () => {
    if (!canvas) return

    // Í∞ùÏ≤¥ Ïù¥ÎèôÏùÑ ÌôúÏÑ±Ìôî
    canvas.selection = true
    canvas.forEachObject(obj => {
      obj.selectable = true
    })

    setIsMovingObject(true)
    setActiveShape('move')
  }

  const disableMoveObject = () => {
    if (!canvas) return

    // Í∞ùÏ≤¥ Ïù¥Îèô ÎπÑÌôúÏÑ±Ìôî
    canvas.selection = false
    canvas.forEachObject(obj => {
      obj.selectable = false
    })

    setIsMovingObject(false)
    setActiveShape(null)
  }

  const disableAll = () => {
    disableDrawing()
    disableErasing()
    disableMoveObject()
    disableAddText()
  }

  /**
   * Í∞ùÏ≤¥ ÏÑ†ÌÉù, Î∞±Ïä§ÌéòÏù¥Ïä§ ÎàÑÎ•¥Î©¥ ÏßÄÏõåÏßê
   */
  useEffect(() => {
    if (!canvas) return
    // 'backspace'ÏôÄ 'delete' ÌÇ§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
    const handleKeyDown = (e: KeyboardEvent) => {
      /**
       * ÌÇ§Î≥¥Îìú ÏûÖÎ†• Ï§ë Î∞±Ïä§ÌéòÏù¥Ïä§Î©¥ Í∞ùÏ≤¥ ÏßÄÏö∞Í∏∞ ÏïàÌï®
       */

      if (isTyping) return
      if (e.key === 'Backspace' || e.key === 'Delete') {
        // ÏÑ†ÌÉùÎêú Í∞ùÏ≤¥Í∞Ä ÌïòÎÇò Ïù¥ÏÉÅ ÏûàÏùÑ Îïå
        const activeObjects = canvas.getActiveObjects()
        if (activeObjects.length > 0) {
          // ÏÑ†ÌÉùÎêú Í∞ùÏ≤¥Îì§ÏùÑ ÏÇ≠Ï†ú
          activeObjects.forEach(obj => {
            canvas.remove(obj)
          })
          canvas.discardActiveObject() // ÏÑ†ÌÉù Ìï¥Ï†ú
          canvas.renderAll() // Ï∫îÎ≤ÑÏä§Î•º Î¶¨Î†åÎçîÎßÅÌïòÏó¨ ÏÇ≠Ï†úÎêú Í∞ùÏ≤¥ Î∞òÏòÅ
        }
      }
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    window.addEventListener('keydown', handleKeyDown)

    // Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ïñ∏ÎßàÏö¥Ìä∏Îê† Îïå Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
    return () => {
      window.removeEventListener('keydown', handleKeyDown)
    }
  }, [canvas, isTyping])

  return (
    <Card className="w-full max-w-4xl mx-auto">
      <CardContent className="p-6">
        <div className="flex space-x-4 mb-4">
          <Button
            onClick={() => {
              disableAll()
              enableMoveObject()
            }}
            variant={activeShape === 'move' ? 'default' : 'outline'}
          >
            <HandIcon className="mr-2 h-4 w-4" />
            ÏÑ†ÌÉù
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" className="w-[100px]">
                <Square className="mr-2 h-4 w-4" />
                ÎèÑÌòï
                <ChevronDown className="ml-2 h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent>
              <DropdownMenuItem
                onSelect={() => {
                  disableAll()
                  addShape('circle')
                }}
              >
                <CircleIcon className="mr-2 h-4 w-4" />Ïõê
              </DropdownMenuItem>
              <DropdownMenuItem
                onSelect={() => {
                  disableAll()
                  addShape('triangle')
                }}
              >
                <TriangleIcon className="mr-2 h-4 w-4" />
                ÏÇºÍ∞ÅÌòï
              </DropdownMenuItem>
              <DropdownMenuItem
                onSelect={() => {
                  disableAll()
                  addShape('rectangle')
                }}
              >
                <Square className="mr-2 h-4 w-4" />
                ÏÇ¨Í∞ÅÌòï
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
          <Button
            onClick={() => {
              disableAll()
              enableDrawing()
            }}
            variant={activeShape === 'pen' ? 'default' : 'outline'}
          >
            <Pen className="mr-2 h-4 w-4" /> Ìéú
          </Button>
          <Button
            onClick={() => {
              disableAll()
              enableErasing()
            }}
            variant={activeShape === 'eraser' ? 'default' : 'outline'}
          >
            <Eraser className="mr-2 h-4 w-4" /> ÏßÄÏö∞Í∞ú
          </Button>
          <Popover>
            <PopoverTrigger asChild>
              <Button variant="outline" className="w-[80px]">
                <div
                  className="w-4 h-4 rounded-full mr-2"
                  style={{ backgroundColor: currentColor }}
                />
                ÏÉâÏÉÅ
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[225px]">
              <ChromePicker
                color={currentColor}
                onChange={handleColorChange}
                onChangeComplete={handleColorChangeComplete}
                disableAlpha={true}
                styles={{
                  default: {
                    picker: { boxShadow: 'none', border: 'none', width: '100%' }
                  }
                }}
              />
              {recentColors.length > 0 && (
                <div className="mt-4 w-full">
                  <p className="text-sm font-medium mb-2">ÏµúÍ∑º ÏÇ¨Ïö©Ìïú ÏÉâÏÉÅ</p>
                  <div className="flex gap-2 justify-between">
                    {recentColors.map((color, index) => (
                      <button
                        key={index}
                        className="w-[32px] h-[32px] rounded-full border border-gray-300"
                        style={{ backgroundColor: color }}
                        onClick={() =>
                          handleColorChangeComplete({
                            hex: color
                          } as ColorResult)
                        }
                        title={`ÏÉâÏÉÅ: ${color}`}
                      />
                    ))}
                  </div>
                </div>
              )}
            </PopoverContent>
          </Popover>
          <Select onValueChange={value => setCurrentThickness(Number(value))}>
            <SelectTrigger className="w-[100px]">
              <SelectValue placeholder="ÍµµÍ∏∞" />
            </SelectTrigger>
            <SelectContent>
              {thicknesses.map(thickness => (
                <SelectItem key={thickness} value={thickness.toString()}>
                  {thickness}px
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <Popover open={isPopoverOpen} onOpenChange={setIsPopoverOpen}>
            <PopoverTrigger asChild>
              <Button
                onClick={() => {
                  if (!isAddingText) {
                    disableAll()
                    enableAddText()
                  }
                }}
                variant={activeShape === 'text' ? 'default' : 'outline'}
              >
                <LetterTextIcon className="mr-2 h-4 w-4" />
                ÌÖçÏä§Ìä∏
              </Button>
            </PopoverTrigger>
            <PopoverContent
              className="w-[225px] mt-2 relative left-0"
              style={{ top: '100%', left: '0' }} // PopoverContentÍ∞Ä Î≤ÑÌäº ÏïÑÎûòÏóê ÎÇòÌÉÄÎÇòÎèÑÎ°ù ÏÑ§Ï†ï
            >
              <div className="space-y-2">
                {' '}
                <div className="flex space-x-2 items-center justify-center">
                  <Button
                    onClick={() => {
                      setIsBold(!isBold)
                    }}
                    variant={isBold === true ? 'default' : 'outline'}
                    className="h-10 w-10 flex items-center justify-center text-lg p-3"
                  >
                    <BoldIcon />
                  </Button>

                  <Button
                    onClick={() => {
                      setIsUnderline(!isUnderline)
                    }}
                    variant={isUnderline === true ? 'default' : 'outline'}
                    className="h-10 w-10 flex items-center justify-center text-lg"
                  >
                    <span className="underline">_</span>
                  </Button>

                  <Button
                    onClick={() => {
                      setIsItalic(!isItalic)
                    }}
                    variant={isItalic === true ? 'default' : 'outline'}
                    className="h-10 w-10 flex items-center justify-center text-lg p-3"
                  >
                    <ItalicIcon />
                  </Button>
                  <div className="flex">
                    <Button
                      onClick={() => {
                        setIsHighlighter(!isHighlighter)
                      }}
                      variant={isHighlighter === true ? 'default' : 'outline'}
                      className="h-10 w-8 flex items-center justify-center text-lg p-2 rounded-r-none"
                    >
                      <HighlighterIcon />
                    </Button>
                    <Popover>
                      <PopoverTrigger asChild>
                        <Button
                          className="h-10 w-auto flex items-center justify-center text-lg p-0 rounded-l-none"
                          variant={'outline'}
                        >
                          ‚åÑ
                        </Button>
                      </PopoverTrigger>
                      <PopoverContent className="flex justify-center">
                        <ChromePicker
                          color={{
                            r: highlighterColor.r || 0,
                            g: highlighterColor.g || 0,
                            b: highlighterColor.b || 0,
                            a: highlighterColor.a || 1
                          }}
                          onChange={color =>
                            setHighlighterColor({
                              r: color.rgb.r ?? 0,
                              g: color.rgb.g ?? 0,
                              b: color.rgb.b ?? 0,
                              a: color.rgb.a ?? 1
                            })
                          }
                          onChangeComplete={color =>
                            setHighlighterColor({
                              r: color.rgb.r ?? 0,
                              g: color.rgb.g ?? 0,
                              b: color.rgb.b ?? 0,
                              a: color.rgb.a ?? 1
                            })
                          }
                        />
                      </PopoverContent>
                    </Popover>
                  </div>
                </div>
                <div className="flex space-x-2">
                  <Select
                    value={font.toString()}
                    onValueChange={value => setFont(value)}
                  >
                    <SelectTrigger className="w-[100px] max-w-[120px] truncate">
                      <SelectValue placeholder={font == '' ? 'Ìè∞Ìä∏' : font} />
                    </SelectTrigger>
                    <SelectContent className="max-h-[300px] overflow-y-auto scroll-smooth">
                      <SelectItem value="Arial" style={{ fontFamily: 'Arial' }}>
                        Arial
                      </SelectItem>
                      <SelectItem
                        value="Courier New"
                        style={{ fontFamily: 'Courier New' }}
                      >
                        Courier New
                      </SelectItem>
                      <SelectItem
                        value="Times New Roman"
                        style={{ fontFamily: 'Times New Roman' }}
                      >
                        Times New Roman
                      </SelectItem>
                      <SelectItem
                        value="Í≤ΩÍ∏∞Ï≤úÎÖÑÎ∞îÌÉï"
                        style={{ fontFamily: 'Í≤ΩÍ∏∞Ï≤úÎÖÑÎ∞îÌÉï' }}
                      >
                        Í≤ΩÍ∏∞Ï≤úÎÖÑÎ∞îÌÉï
                      </SelectItem>
                      <SelectItem
                        value="Ï°∞ÏÑ†100ÎÖÑÏ≤¥"
                        style={{ fontFamily: 'Ï°∞ÏÑ†100ÎÖÑÏ≤¥' }}
                      >
                        Ï°∞ÏÑ†100ÎÖÑÏ≤¥
                      </SelectItem>
                      <SelectItem
                        value="Í≥†Ïö¥ÎèãÏõÄ-Regular"
                        style={{ fontFamily: 'Í≥†Ïö¥ÎèãÏõÄ-Regular' }}
                      >
                        Í≥†Ïö¥ÎèãÏõÄ-Regular
                      </SelectItem>
                      <SelectItem
                        value="ÌîÑÎ¶¨ÌÖêÎã§Îìú"
                        style={{ fontFamily: 'ÌîÑÎ¶¨ÌÖêÎã§Îìú' }}
                      >
                        ÌîÑÎ¶¨ÌÖêÎã§Îìú
                      </SelectItem>
                      <SelectItem
                        value="ÏóêÏä§ÏΩîÏñ¥ÎìúÎ¶º"
                        style={{ fontFamily: 'ÏóêÏä§ÏΩîÏñ¥ÎìúÎ¶º' }}
                      >
                        ÏóêÏä§ÏΩîÏñ¥ÎìúÎ¶º
                      </SelectItem>
                      <SelectItem
                        value="Î¨∏Í≤ΩÍ∞êÌôçÏÇ¨Í≥º"
                        style={{ fontFamily: 'Î¨∏Í≤ΩÍ∞êÌôçÏÇ¨Í≥º' }}
                      >
                        Î¨∏Í≤ΩÍ∞êÌôçÏÇ¨Í≥º
                      </SelectItem>
                      <SelectItem
                        value="Î≤†Ïù¥Í∏ÄÌåª"
                        style={{ fontFamily: 'Î≤†Ïù¥Í∏ÄÌåª' }}
                      >
                        Î≤†Ïù¥Í∏ÄÌåª
                      </SelectItem>
                      <SelectItem
                        value="Ï£ºÏïÑÏ≤¥"
                        style={{ fontFamily: 'Ï£ºÏïÑÏ≤¥' }}
                      >
                        Ï£ºÏïÑÏ≤¥
                      </SelectItem>
                      <SelectItem
                        value="ÏñëÏßÑÏ≤¥"
                        style={{ fontFamily: 'ÏñëÏßÑÏ≤¥' }}
                      >
                        ÏñëÏßÑÏ≤¥
                      </SelectItem>
                      <SelectItem
                        value="Ïø†ÌÇ§Îü∞"
                        style={{ fontFamily: 'Ïø†ÌÇ§Îü∞' }}
                      >
                        Ïø†ÌÇ§Îü∞
                      </SelectItem>
                      <SelectItem
                        value="ÌÉúÎÇòÎã§Ï≤¥"
                        style={{ fontFamily: 'ÌÉúÎÇòÎã§Ï≤¥' }}
                      >
                        ÌÉúÎÇòÎã§Ï≤¥
                      </SelectItem>
                      <SelectItem
                        value="Í∞ïÏõêÍµêÏú°ÌäºÌäºÏ≤¥"
                        style={{ fontFamily: 'Í∞ïÏõêÍµêÏú°ÌäºÌäºÏ≤¥' }}
                      >
                        Í∞ïÏõêÍµêÏú°ÌäºÌäºÏ≤¥
                      </SelectItem>
                      <SelectItem
                        value="ÏÑ§Î¶ΩÏ≤¥ Ïú†Í±¥Ïö±"
                        style={{ fontFamily: 'ÏÑ§Î¶ΩÏ≤¥ Ïú†Í±¥Ïö±' }}
                      >
                        ÏÑ§Î¶ΩÏ≤¥ Ïú†Í±¥Ïö±
                      </SelectItem>
                      <SelectItem
                        value="Î°ØÎç∞Î¶¨ÏïÑ Îî±Î∂ôÏñ¥Ï≤¥"
                        style={{ fontFamily: 'Î°ØÎç∞Î¶¨ÏïÑ Îî±Î∂ôÏñ¥Ï≤¥' }}
                      >
                        Î°ØÎç∞Î¶¨ÏïÑ Îî±Î∂ôÏñ¥Ï≤¥
                      </SelectItem>
                      <SelectItem
                        value="Ïñ¥Í∑∏Î°úÏ≤¥"
                        style={{ fontFamily: 'Ïñ¥Í∑∏Î°úÏ≤¥' }}
                      >
                        Ïñ¥Í∑∏Î°úÏ≤¥
                      </SelectItem>
                      <SelectItem
                        value="ÌååÏÖúÏÇ∞Ïä§-Regular"
                        style={{ fontFamily: 'ÌååÏÖúÏÇ∞Ïä§-Regular' }}
                      >
                        ÌååÏÖúÏÇ∞Ïä§-Regular
                      </SelectItem>
                    </SelectContent>
                  </Select>
                  {/* Í∏ÄÍº¥ ÌÅ¨Í∏∞ ÏÑ†ÌÉù */}
                  <Select
                    value={fontSize.toString()}
                    onValueChange={value => setFontSize(Number(value))}
                  >
                    <SelectTrigger className="w-[100px] max-w-[120px] truncate">
                      <SelectValue placeholder="ÌÅ¨Í∏∞" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="12">12px</SelectItem>
                      <SelectItem value="16">16px</SelectItem>
                      <SelectItem value="20">20px</SelectItem>
                      <SelectItem value="24">24px</SelectItem>
                      <SelectItem value="32">32px</SelectItem>
                      <SelectItem value="48">48px</SelectItem>
                      <SelectItem value="60">60px</SelectItem>
                      <SelectItem value="72">72px</SelectItem>
                    </SelectContent>
                  </Select>
                  <Popover>
                    <PopoverTrigger asChild>
                      <Button
                        className="h-9 w-10 p-0 flex items-center justify-center"
                        variant={'outline'}
                      >
                        {/* ÏÉâÏÉÅ Ïõê */}
                        <div
                          style={{
                            backgroundColor: currentTextColor,
                            borderRadius: '50%',
                            aspectRatio: '1', // Ï†ïÏÇ¨Í∞ÅÌòï ÎπÑÏú® Ïú†ÏßÄ
                            width: '80%', // Î≤ÑÌäº ÌÅ¨Í∏∞Ïóê Îî∞Îùº ÏûêÎèôÏúºÎ°ú ÌÅ¨Í∏∞ Ï°∞Ï†ï
                            height: '80%' // Ï†úÍ±∞ÌïòÍ±∞ÎÇò Ïú†ÏßÄÌï¥ÎèÑ Ï¢ãÏùå (aspectRatioÎ°ú Ïù¥ÎØ∏ ÌÅ¨Í∏∞ ÎπÑÏú®Ïù¥ Í≥†Ï†ïÎê®)
                          }}
                        />
                      </Button>
                    </PopoverTrigger>
                    <PopoverContent className="flex justify-center p-2">
                      <ChromePicker
                        color={{
                          r:
                            parseInt(
                              currentTextColor.slice(5).split(',')[0].trim()
                            ) || 0,
                          g:
                            parseInt(
                              currentTextColor.slice(5).split(',')[1].trim()
                            ) || 0,
                          b:
                            parseInt(
                              currentTextColor.slice(5).split(',')[2].trim()
                            ) || 0,
                          a:
                            parseFloat(
                              currentTextColor.slice(5).split(',')[3].trim()
                            ) || 1
                        }}
                        onChange={handleTextColorChange}
                        onChangeComplete={handleTextColorChangeComplete}
                      />
                    </PopoverContent>
                  </Popover>
                </div>
                <div
                  className={`mt-2 overflow-y-scroll bg-gray-800 p-2 rounded-lg space-y-2`}
                  style={{
                    height:
                      apiTextData && apiTextData.length > 0
                        ? `${Math.min(apiTextData.length * 60, 250)}px`
                        : '2.5rem'
                  }}
                >
                  {apiTextData && apiTextData.length > 0 ? (
                    apiTextData.map((text, index) => (
                      <Button
                        key={index}
                        onClick={value => {
                          addTextByButton(apiTextData[index])
                        }}
                        className="w-full max-w-full h-auto px-2 py-1 border border-gray-500 text-white rounded-md whitespace-normal overflow-hidden break-words"
                        variant="outline"
                      >
                        {text}
                      </Button>
                    ))
                  ) : (
                    <div className="text-white flex items-center justify-center">
                      Ï∂îÏ≤ú Î¨∏Íµ¨Í∞Ä ÏóÜÏäµÎãàÎã§.
                    </div>
                  )}
                </div>
              </div>
            </PopoverContent>
          </Popover>
        </div>
        <canvas ref={canvasRef} />
      </CardContent>
    </Card>
  )
}
